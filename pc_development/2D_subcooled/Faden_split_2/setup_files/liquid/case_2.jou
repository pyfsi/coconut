file set-batch-options n n n
(enable-dynamic-mesh-node-ids #t)
;file start "transcript_setup.txt"
file read-case 2D_liquid_BL.msh
grid modify-zones zone-type fluid fluid

define user-defined user-defined-memory 13
define user-defined user-defined-node-memory 1

define models unsteady-2nd-order y
define models viscous laminar y
define models solver pressure-based y
define models energy y n n n y
solve set equations flow y

define materials data-base database-type user-defined "liquid_octadecane"
define materials copy fluid pcm

define boundary-conditions fluid , y pcm n n n n , n , n y n
define boundary-conditions wall bottom n 0 n 0 n n n 0 y motion-bc-stationary n n ,
define boundary-conditions wall top n 0 n 0 n n n 0 y motion-bc-stationary n n ,

;heated wall 10 Â°C above melting temp.
define boundary-conditions wall heated n 0 n 0 n y temperature n 311.13 y motion-bc-stationary n n ,
define boundary-conditions wall boundary n 0 n 0 n y temperature n 301.13 y motion-bc-stationary n n ,

;outlet for volume change due to phase change
define boundary-conditions zone-type outlet pressure-outlet
define boundary-conditions pressure-outlet outlet y n 0 n 306.13 n y y n n

define operating-conditions operating-pressure 0
define operating-conditions gravity y 0 -9.81

solve monitors residual check-convergence y y y y
solve monitors residual convergence-criteria 1e-3 1e-4 1e-4 1e-10

solve set discretization-scheme temperature 1
solve set discretization-scheme mom 1
; 10: standard, 11: linear, 14: PRESTO!, 13: body force weighted
solve set discretization-scheme pressure 13
solve set gradient-scheme n y
; SIMPLE (20) - PISO (22) - coupled (24)
solve set p-v-coupling 22

solve set under-relaxation density 0.9
solve set under-relaxation body-force 0.9
solve set under-relaxation mom 0.7
solve set under-relaxation temperature 0.9
solve set under-relaxation pressure 0.3

; p-v coupled: mom & pressure relaxation
;solve set p-v-controls 200 0.75 0.75

;Initialise liquid according to Stefan solution
solve initialize set-defaults temperature 301.13
define user-defined compiled-functions compile "stefan" y "stefan.c" "" ""
define user-defined compiled-functions load "stefan"
define user-defined function-hooks initialization "temp_ini::stefan" ""

solve initialize set-defaults pressure 0
solve initialize set-defaults x-velocity 0
solve initialize set-defaults y-velocity 0
solve initialize initialize-flow

define dynamic-mesh dynamic-mesh y n n n n
define dynamic-mesh controls smoothing y
define dynamic-mesh controls smoothing-parameters smoothing-method spring
define dynamic-mesh controls smoothing-parameters constant-factor 1
; NOTE: bnd-node-relaxation 0 prevents deforming boundary nodes from moving
;define dynamic-mesh controls smoothing-parameters bnd-node-relaxation 1
;define dynamic-mesh controls smoothing-parameters bnd-stiffness-factor 1
define dynamic-mesh controls smoothing-parameters skew-smooth-niter 10
define dynamic-mesh controls smoothing-parameters skew-smooth-cell-skew-max 0.7
define dynamic-mesh controls smoothing-parameters max-iter 50
define dynamic-mesh controls smoothing-parameters spring-on-all-elements y
define dynamic-mesh controls layering n
define dynamic-mesh controls remeshing y
define dynamic-mesh controls remeshing-parameters unified-remeshing? y
define dynamic-mesh controls remeshing-parameters retain-size-distribution? y
define dynamic-mesh controls remeshing-parameters cell-skew-max 0.4

; Print remeshing details to console!
define dynamic-mesh transient-settings verbosity 3

; Last option below: exclude mesh motion in boundary conditions? y --> fluid should not move due to interface motion
; Third option below: use Laplace instead of spring smoothing? n --> springs ensure the BL cells remain the same thickness on the endwalls
define dynamic-mesh zones create top deforming plane 0.0002 0.04 0 1 n y n y y y y n y
define dynamic-mesh zones create bottom deforming plane 0.0002 0 0 1 n y n y y y y n y
define dynamic-mesh zones create outlet stationary fluid , , n

solve initialize initialize-flow

; Report definitions and report file
solve report-definitions add vol volume-zonevol
zone-names fluid ()
per-zone? no
q

solve report-definitions add vmax volume-max
field velocity-magnitude
zone-names fluid ()
per-zone? no
q

solve report-definitions add heated-flux surface-areaavg
field heat-flux
surface-names heated ()
per-surface? no
q

surface rake-surface u1 0.0 0.03 0.01 0.03 2
surface rake-surface u2 0.0 0.03 0.02 0.03 2
surface rake-surface u3 0.0 0.03 0.03 0.03 2
surface rake-surface l1 0.0 0.01 0.01 0.01 2
surface rake-surface l2 0.0 0.01 0.03 0.01 2

solve report-definitions add temp-u1 surface-vertexmin
field temperature
surface-names u1 ()
per-surface? no
q

solve report-definitions add temp-u2 surface-vertexmin
field temperature
surface-names u2 ()
per-surface? no
q

solve report-definitions add temp-u3 surface-vertexmin
field temperature
surface-names u3 ()
per-surface? no
q

solve report-definitions add temp-l1 surface-vertexmin
field temperature
surface-names l1 ()
per-surface? no
q

solve report-definitions add temp-l2 surface-vertexmin
field temperature
surface-names l2 ()
per-surface? no
q

solve report-files add report-file
report-defs vol vmax heated-flux temp-u1 temp-u2 temp-u3 temp-l1 temp-l2 ()
file-name "./report-file.out"
active? yes
q

file write-case-data 2D_fluid.cas.h5
exit
